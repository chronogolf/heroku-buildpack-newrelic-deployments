#!/usr/bin/env bash

set -eo pipefail

ENV_DIR=$3

indent() {
  sed 's/^/       /'
}

export "NEW_RELIC_API_KEY=$(cat $ENV_DIR/NEW_RELIC_API_KEY)"
export "NEW_RELIC_APP_ID=$(cat $ENV_DIR/NEW_RELIC_APP_ID)"

echo -e "-----> New Relic Deployment\n"

if [ -z ${NEW_RELIC_API_KEY+x} ||  -z ${NEW_RELIC_APP_ID+x} ]; then
  echo "Missing NEW_RELIC_API_KEY or NEW_RELIC_APP_ID" | indent
  exit 1
else
  echo -e "Creating deployment for $NEW_RELIC_APP_ID\n" | indent

  curl -s -X POST "https://api.newrelic.com/v2/applications/$NEW_RELIC_APP_ID/deployments.json" \
      -H "X-Api-Key:$NEW_RELIC_API_KEY" -i \
      -H 'Content-Type: application/json' \
      -d '{ "deployment": { "revision": "'$SOURCE_VERSION'", "user": "Heroku" } }' \
      | indent
fi
